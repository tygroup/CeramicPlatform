<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cpf.mapper.transaction.TraProductMapper">
  <resultMap id="BaseResultMap" type="com.cpf.beans.transaction.TraProduct">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="productid" jdbcType="VARCHAR" property="productid" />
    <result column="productcode" jdbcType="VARCHAR" property="productcode" />
    <result column="userid" jdbcType="VARCHAR" property="userid" />
    <result column="productname" jdbcType="VARCHAR" property="productname" />
    <result column="author" jdbcType="VARCHAR" property="author" />
    <result column="cateid" jdbcType="VARCHAR" property="cateid" />
    <result column="isfinished" jdbcType="VARCHAR" property="isfinished" />
    <result column="defect" jdbcType="VARCHAR" property="defect" />
    <result column="isOriginal" jdbcType="VARCHAR" property="isoriginal" />
    <result column="ismyself" jdbcType="VARCHAR" property="ismyself" />
    <result column="longl" jdbcType="VARCHAR" property="longl" />
    <result column="width" jdbcType="VARCHAR" property="width" />
    <result column="Material" jdbcType="VARCHAR" property="material" />
    <result column="Framed" jdbcType="VARCHAR" property="framed" />
    <result column="shape" jdbcType="VARCHAR" property="shape" />
    <result column="era" jdbcType="VARCHAR" property="era" />
    <result column="cretime" jdbcType="DATE" property="cretime" />
    <result column="state" jdbcType="VARCHAR" property="state" />
    <result column="isMultiple" jdbcType="DECIMAL" property="ismultiple" />
    <result column="modDate" jdbcType="DATE" property="moddate" />
    <result column="num" jdbcType="VARCHAR" property="num"/>
    <result column="storename"  jdbcType="VARCHAR"  property="storename"/>
    
  </resultMap>
  
  
  
  
  
    <resultMap id="FilesResultMap" type="com.cpf.beans.transaction.TraProduct">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="productid" jdbcType="VARCHAR" property="productid" />
    <result column="productcode" jdbcType="VARCHAR" property="productcode" />
    <result column="userid" jdbcType="VARCHAR" property="userid" />
    <result column="productname" jdbcType="VARCHAR" property="productname" />
    <result column="author" jdbcType="VARCHAR" property="author" />
    <result column="cateid" jdbcType="VARCHAR" property="cateid" />
    <result column="isfinished" jdbcType="VARCHAR" property="isfinished" />
    <result column="defect" jdbcType="VARCHAR" property="defect" />
    <result column="isOriginal" jdbcType="VARCHAR" property="isoriginal" />
    <result column="ismyself" jdbcType="VARCHAR" property="ismyself" />
    <result column="longl" jdbcType="VARCHAR" property="longl" />
    <result column="width" jdbcType="VARCHAR" property="width" />
    <result column="Material" jdbcType="VARCHAR" property="material" />
    <result column="Framed" jdbcType="VARCHAR" property="framed" />
    <result column="shape" jdbcType="VARCHAR" property="shape" />
    <result column="era" jdbcType="VARCHAR" property="era" />
    <result column="cretime" jdbcType="DATE" property="cretime" />
    <result column="state" jdbcType="VARCHAR" property="state" />
    <result column="isMultiple" jdbcType="DECIMAL" property="ismultiple" />
    <result column="modDate" jdbcType="DATE" property="moddate" />
    <result column="num" jdbcType="VARCHAR" property="num"/>
    <result column="storename"  jdbcType="VARCHAR"  property="storename"/>
    
    <collection property="pics" ofType="com.cpf.beans.transaction.TraProductFiles">
	     <id column="filesid" property="filesid" jdbcType="VARCHAR" />
	    <result column="productid" property="productid" jdbcType="VARCHAR" />
	    <result column="files" property="files" jdbcType="VARCHAR" />
    </collection>
  </resultMap>
  
  <!--分页 查询首页易物搜索列表 -->
   <select id="selectBartersBySearch" resultMap="BaseResultMap">
	    select * from ( select t.productid productid,p.productname productname,p.productcode productcode,u.storename storename,count(c.collectId) num from tra_trading t 
		LEFT JOIN tra_product p on t.productid = p.productid
		LEFT JOIN sys_collect c on t.productid = c.productId and c.collectType = '0'
		LEFT JOIN userinfo u on p.userid = u.userid
		where t.toused = '1' and t.isAudit = '0' and t.isshelf = '0'
		<!-- 商品名称搜索 -->
		 <if test="productName != null and productName!='' " >
     		 and p.productname  like CONCAT('%',#{productName},'%')
      	</if>
      	 <!-- 商品分类搜索 -->
		 <if test="cateid != null and cateid!='' " >
     		 and p.cateid =#{cateid}
      	</if>
      	
      		 <!-- 商品来源搜索 -->
		 <if test="ismyself != null and ismyself!='' " >
     		 and p.ismyself =#{ismyself}
      	</if>
      	
      		 <!-- 年代搜索 -->
		 <if test="era != null and era!='' " >
     		 and p.era =#{era}
      	</if>
		group by productId,productName,productCode,storename
		
		 <if test="sort!=null and sort=='0'">
		 <!-- 按照日期排序 -->
		 	order by t.auditDate desc 
		 </if>
		  <if test="sort!=null and sort=='1'">
		 	<!-- 按照搜藏排序 -->
		 	order by num desc 
		 </if>
		 ) tt   
		 limit #{beginIndex},#{endIndex};
   </select>
     <select id="selectBartersBySearchCount" resultType="java.lang.Integer">
     select count(0) from (
	   select t.productid productid,p.productname productname,p.productcode productcode,u.storename storename,count(c.collectId) num from tra_trading t 
		LEFT JOIN tra_product p on t.productid = p.productid
		LEFT JOIN sys_collect c on t.productid = c.productId and c.collectType = '0'
		LEFT JOIN userinfo u on p.userid = u.userid
		where t.toused = '1' and t.isAudit = '0' and t.isshelf = '0'
			<!-- 商品名称搜索 -->
		 <if test="productName != null and productName!='' " >
     		 and p.productname  like CONCAT('%',#{productName},'%')
      	</if>
      	 <!-- 商品分类搜索 -->
		 <if test="cateid != null and cateid!='' " >
     		 and p.cateid =#{cateid}
      	</if>
      	
      		 <!-- 商品来源搜索 -->
		 <if test="ismyself != null and ismyself!='' " >
     		 and p.ismyself =#{ismyself}
      	</if>
      	
      		 <!-- 年代搜索 -->
		 <if test="era != null and era!='' " >
     		 and p.era =#{era}
      	</if>
		group by productId,productName,productCode,storename  order by t.auditDate desc  ) tt
   </select>
   
     <resultMap id="SpecialResultMap" type="com.cpf.beans.transaction.SpecialBean">
    <result column="productid" jdbcType="VARCHAR" property="productid" />
    <result column="productname" jdbcType="VARCHAR" property="productname" />
    <result column="Startingprice" jdbcType="VARCHAR" property="Startingprice" />
    <result column="zcType" jdbcType="VARCHAR" property="zcType" />
    <result column="zcid" jdbcType="VARCHAR" property="zcid" />
    <result column="num" jdbcType="VARCHAR" property="num" />
    <result column="pricetime" jdbcType="VARCHAR" property="pricetime" />
    <result column="begintime" jdbcType="VARCHAR" property="begintime" />
    <result column="endtime" jdbcType="VARCHAR" property="endtime" />
   <collection property="pics" ofType="com.cpf.beans.transaction.TraProductFiles">
	     <id column="filesid" property="filesid" jdbcType="VARCHAR" />
	    <result column="productid" property="productid" jdbcType="VARCHAR" />
	    <result column="files" property="files" jdbcType="VARCHAR" />
    </collection>
  </resultMap>
   <!-- 查询首页 拍品搜索sql -->
   <select id="selectSpecialBySearch"  resultMap="SpecialResultMap">
	    select * from ( select *
			 from (SELECT
				t.productid productid,
				p.productname productname,
				t.begintime begintime,
				t.endtime endtime,
				t.Startingprice Startingprice,
				t.zcType zcType,
				t.zcid zcid,
				COUNT(c.collectId) num,
				COUNT(b.recordid) pricetime
			FROM
				tra_trading t
			LEFT JOIN tra_product p ON t.productid = p.productid
			LEFT JOIN sys_collect c on t.productid = c.productId
			LEFT JOIN tra_Bidrecord b on t.productid = b.productid
			WHERE
				t.isshelf = '0'
			AND t.isAudit = '0'
			AND t.toused = '0'
			<if test="productName != null and productName!='' " >
			AND p.productname like CONCAT('%',#{productName},'%')
			</if>
			
			 <!-- 商品分类搜索 -->
		 <if test="cateid != null and cateid!='' " >
     		 and p.cateid =#{cateid}
      	</if>
      	
      		 <!-- 商品来源搜索 -->
		 <if test="ismyself != null and ismyself!='' " >
     		 and p.ismyself =#{ismyself}
      	</if>
      	
      		 <!-- 年代搜索 -->
		 <if test="era != null and era!='' " >
     		 and p.era =#{era}
      	</if>
		
			group by productid,productname,Startingprice,zcType,zcid
			
	<if test="sort!=null and sort=='0'">
		 <!-- 按照日期排序 -->
		 	order by t.auditDate desc 
		 </if>
		  <if test="sort!=null and sort=='1'">
		 	<!-- 按照搜藏排序 -->
		 	order by num desc 
		 </if>
		  ) tt ) ttt      limit #{beginIndex},#{endIndex};
   
   </select>
      <!-- 查询分页需要的总数量 -->
      <select id="selectSpecialBySearchCount"  resultType="java.lang.Integer">
	   select count(0)
			 from (SELECT
				t.productid productid,
				p.productname productname,
				t.Startingprice Startingprice,
				t.zcType zcType,
				t.zcid zcid,
				COUNT(c.collectId) num,
				COUNT(b.recordid) pricetime
			FROM
				tra_trading t
			LEFT JOIN tra_product p ON t.productid = p.productid
			LEFT JOIN sys_collect c on t.productid = c.productId
			LEFT JOIN tra_Bidrecord b on t.productid = b.productid
			WHERE
				t.isshelf = '0'
			AND t.isAudit = '0'
			AND t.toused = '0'
			<if test="productName != null and productName!='' " >
			AND p.productname like CONCAT('%',#{productName},'%')
			</if>
			
			 <!-- 商品分类搜索 -->
		 <if test="cateid != null and cateid!='' " >
     		 and p.cateid =#{cateid}
      	</if>
      	
      		 <!-- 商品来源搜索 -->
		 <if test="ismyself != null and ismyself!='' " >
     		 and p.ismyself =#{ismyself}
      	</if>
      	
      		 <!-- 年代搜索 -->
		 <if test="era != null and era!='' " >
     		 and p.era =#{era}
      	</if>
			group by productid,productname,Startingprice,zcType,zcid
 
		 	order by t.auditDate desc 
		  
		  
		  )tt   
   
   </select>
   
   
   	<!-- 查询热门的拍品 根据count拿数据 -->
   	<select id="selectHotSpecialid" resultMap="SpecialResultMap">
   	select * from ( select tt.* ,
			 if(tt.zcType='1',
			(select o.Previewbegintimetime from tra_officialspecial o where o.Officialid = tt.zcid ) ,
			(select p.Previewbegintimetime from tra_personalspecial p where tt.zcid = p.Specialid)
			) as begintime,
			 if(tt.zcType='1',
			(select o.Previewendtime from tra_officialspecial o where o.Officialid = tt.zcid ) ,
			(select p.Previewendtime from tra_personalspecial p where tt.zcid = p.Specialid)
			) as endtime from (SELECT
				t.productid productid,
				p.productname productname,
				t.Startingprice Startingprice,
				t.zcType zcType,
				t.zcid zcid,
				COUNT(c.collectId) num,
				COUNT(b.recordid) pricetime
			FROM
				tra_trading t
			LEFT JOIN tra_product p ON t.productid = p.productid
			LEFT JOIN sys_collect c on t.productid = c.productId
			LEFT JOIN tra_Bidrecord b on t.productid = b.productid

	where t.is_hot = '0' and t.toused = '0' and t.isshelf ='0' and t.isAudit='0' and t.is_deal='1'
	group by productid,productname,Startingprice,zcType,zcid
	) tt )ttt    LIMIT #{beginIndex},#{size}
   	
   	</select>
   	<!-- 查询热门易物 -->
   	<select id="selectHotBarters"  resultMap="BaseResultMap">
   	select * from ( SELECT
				t.productid productid,
				p.productname productname,
				u.storename storename
			FROM
				tra_trading t
			LEFT JOIN tra_product p ON t.productid = p.productid
			LEFT JOIN userinfo u on p.userid = u.userid

	where t.is_hot = '0' and t.toused = '1' and t.isshelf ='0' and t.isAudit='0' and t.is_deal='1'
	) tt   
 	LIMIT #{beginIndex},#{size}
   	</select>
   	
   	
   <insert id="save" parameterType="TraProduct" >
    insert into tra_product
      	<selectKey resultType="java.lang.String"  order="BEFORE" keyProperty="productid">  
	 	 	  SELECT REPLACE(UUID(), '-', '')   
	    </selectKey> 
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="productid != null" >
        productid,
      </if>
      <if test="userid != null" >
        userid,
      </if>
      <if test="productname != null" >
        productname,
      </if>
      <if test="author != null" >
        author,
      </if>
      <if test="cateid != null" >
        cateid,
      </if>
      <if test="details != null" >
        details,
      </if>
      <if test="isfinished != null" >
        isfinished,
      </if>
      <if test="defect != null" >
        defect,
      </if>
      <if test="isoriginal != null" >
        isoriginal,
      </if>
      <if test="ismyself != null" >
        ismyself,
      </if>
      
      <if test="longl != null" >
        longl,
      </if>
       <if test="width != null" >
        width,
      </if>
       <if test="material != null" >
        material,
      </if>
      <if test="framed != null" >
        framed,
      </if>
      <if test="shape != null" >
        shape,
      </if>
      <if test="era != null" >
        era,
      </if>
      <if test="ismultiple != null" >
        ismultiple,
      </if>
       <if test="moddate != null" >
        moddate,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      
      <if test="productid != null" >
        #{productid,jdbcType=VARCHAR},
      </if>
      <if test="userid != null" >
        #{userid,jdbcType=VARCHAR},
      </if>
      <if test="productname != null" >
       #{productname,jdbcType=VARCHAR},
      </if>
      <if test="author != null" >
        #{author,jdbcType=VARCHAR},
      </if>
      <if test="cateid != null" >
         #{cateid,jdbcType=VARCHAR},
      </if>
      <if test="details != null" >
        #{details,jdbcType=VARCHAR},
      </if>
      <if test="isfinished != null" >
         #{isfinished,jdbcType=VARCHAR},
      </if>
      <if test="defect != null" >
       #{defect,jdbcType=VARCHAR},
      </if>
      <if test="isoriginal != null" >
        #{isoriginal,jdbcType=VARCHAR},
      </if>
      <if test="ismyself != null" >
         #{ismyself,jdbcType=VARCHAR},
      </if>
      <if test="longl != null" >
         #{longl,jdbcType=VARCHAR},
      </if>
       <if test="width != null" >
          #{width,jdbcType=VARCHAR},
      </if>
       <if test="material != null" >
         #{material,jdbcType=VARCHAR},
      </if>
      <if test="framed != null" >
        #{framed,jdbcType=VARCHAR},
      </if>
      <if test="shape != null" >
         #{shape,jdbcType=VARCHAR},
      </if>
      <if test="era != null" >
        #{era,jdbcType=VARCHAR},
      </if>
      <if test="ismultiple != null" >
       #{ismultiple,jdbcType=VARCHAR},
      </if>
       <if test="moddate != null" >
        #{moddate,jdbcType=VARCHAR},
      </if>
       
    </trim>
  </insert>
  
  
  <update id="update" parameterType="TraProduct" >
   
    update Tra_Product
    <set >
      <if test="productname != null" >
       productname =#{productname,jdbcType=VARCHAR},
      </if>
      <if test="author != null" >
       author =  #{author,jdbcType=VARCHAR},
      </if>
      <if test="cateid != null" >
        cateid =  #{cateid,jdbcType=VARCHAR},
      </if>
      <if test="details != null" >
        details = #{details,jdbcType=VARCHAR},
      </if>
      <if test="isfinished != null" >
         isfinished = #{isfinished,jdbcType=VARCHAR},
      </if>
      <if test="defect != null" >
       defect = #{defect,jdbcType=VARCHAR},
      </if>
      <if test="isoriginal != null" >
       isoriginal= #{isoriginal,jdbcType=VARCHAR},
      </if>
      <if test="ismyself != null" >
         ismyself=#{ismyself,jdbcType=VARCHAR},
      </if>
      <if test="longl != null" >
        longl= #{longl,jdbcType=VARCHAR},
      </if>
       <if test="width != null" >
         width= #{width,jdbcType=VARCHAR},
      </if>
       <if test="material != null" >
         material=#{material,jdbcType=VARCHAR},
      </if>
      <if test="framed != null" >
        framed = #{framed,jdbcType=VARCHAR},
      </if>
      <if test="shape != null" >
       shape =   #{shape,jdbcType=VARCHAR},
      </if>
      <if test="era != null" >
       era =  #{era,jdbcType=VARCHAR},
      </if>
      <if test="ismultiple != null" >
      ismultiple =  #{ismultiple,jdbcType=VARCHAR},
      </if>
       moddate=current_timestamp(),
    </set>
    where productid = #{productid,jdbcType=VARCHAR}
  </update>
  

  <select id="findById" parameterType="java.lang.String">
 	select * from  Tra_Product  where productid = #{productid,jdbcType=VARCHAR}
  </select>
  <!--用户查询自己的商品 -->
  <select id="selectProductsByUserId" resultType="TraProduct">
	   	select * from tra_product  tt  	where 1=1  
	   	<if test="userId != null" >
	      userId =  #{userId,jdbcType=VARCHAR},
	    </if> 
	     
	 	LIMIT #{beginIndex},#{endIndex}
</select>
  <select id="findById" parameterType="java.lang.String" resultType="TraProduct">
 	select * from  Tra_Product  where productid = #{productid,jdbcType=VARCHAR}
  </select>
  <!--用户查询自己的商品 -->
  <select id="selectProductsByUserId" resultType="TraProduct">
	   	select * from tra_product  tt  	where state=0  
	   	<if test="map.userId != null" >
	     and  userId =  #{map.userId,jdbcType=VARCHAR}
	    </if> 
	     
	 	LIMIT #{map.beginIndex},#{map.endIndex}
  </select>
  
   <select id="findByUseridCount" resultType="java.lang.Integer">
	   	select count(productid) from tra_product  tt  	where state=0  
	   	<if test="map.userId != null" >
	     and userId =  #{map.userId,jdbcType=VARCHAR}
	    </if> 
  </select>
  
   <!--用户查询拍卖或者易物的商品 -->
  <select id="selectProductsByUserIdforSJ" resultType="TraProduct" parameterType="map">
	   	select t.*,pro.productid,files.files from tra_trading  t 
		LEFT JOIN tra_product pro on t.productid = pro.productid
		left join tra_product_files files on files.productid=pro.productid
		where  t.isshelf=0 and t.isAudit=0
	   	<if test="map.userId != null and map.userId != ''" >
	     and pro.userid= #{map.userId,jdbcType=VARCHAR}
	    </if> 
	    <if test="map.isAudit != null and map.isAudit != ''" >
	     and pro.isAudit= #{map.isAudit,jdbcType=VARCHAR}
	    </if> 
	    <if test="map.isPm != null and map.isPm != '' " >
	     and pro.is_deal= #{map.isPm,jdbcType=VARCHAR}
	    </if> 
	     
	 	LIMIT #{map.beginIndex},#{map.endIndex}
  </select>
  
   <select id="selectProductsByUseridCountforSJ" parameterType="map" resultType="java.lang.Integer">
	   	select count(t.tradingid) from tra_trading  t 
		LEFT JOIN tra_product pro on t.productid = pro.productid
		left join tra_product_files files on files.productid=pro.productid
		where  t.isshelf=0 and t.isAudit=0
	   	<if test="map.userId != null and map.userId != ''" >
	     and pro.userid= #{map.userId,jdbcType=VARCHAR}
	    </if> 
	    <if test="map.isAudit != null and map.isAudit != ''" >
	     and pro.isAudit= #{map.isAudit,jdbcType=VARCHAR}
	    </if> 
	    <if test="map.isPm != null and map.isPm != '' " >
	     and pro.is_deal= #{map.isPm,jdbcType=VARCHAR}
	    </if> 
	     
  </select>
</mapper>
