<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cpf.mapper.transaction.TraProductMapper">
  <resultMap id="BaseResultMap" type="com.cpf.beans.transaction.TraProduct">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="productid" jdbcType="VARCHAR" property="productid" />
    <result column="productcode" jdbcType="VARCHAR" property="productcode" />
    <result column="userid" jdbcType="VARCHAR" property="userid" />
    <result column="productname" jdbcType="VARCHAR" property="productname" />
    <result column="author" jdbcType="VARCHAR" property="author" />
    <result column="cateid" jdbcType="VARCHAR" property="cateid" />
    <result column="isfinished" jdbcType="VARCHAR" property="isfinished" />
    <result column="defect" jdbcType="VARCHAR" property="defect" />
    <result column="isOriginal" jdbcType="VARCHAR" property="isoriginal" />
    <result column="ismyself" jdbcType="VARCHAR" property="ismyself" />
    <result column="longl" jdbcType="VARCHAR" property="longl" />
    <result column="width" jdbcType="VARCHAR" property="width" />
    <result column="Material" jdbcType="VARCHAR" property="material" />
    <result column="Framed" jdbcType="VARCHAR" property="framed" />
    <result column="shape" jdbcType="VARCHAR" property="shape" />
    <result column="era" jdbcType="VARCHAR" property="era" />
    <result column="cretime" jdbcType="DATE" property="cretime" />
    <result column="state" jdbcType="VARCHAR" property="state" />
    <result column="isMultiple" jdbcType="DECIMAL" property="ismultiple" />
    <result column="modDate" jdbcType="DATE" property="moddate" />
    <result column="num" jdbcType="VARCHAR" property="num"/>
  </resultMap>
  <!--分页 查询首页易物搜索列表 -->
   <select id="selectBartersBySearch" resultMap="BaseResultMap">
	   select t.productid productid,p.productname productname,p.productcode productcode,count(c.collectId) num from tra_trading t 
		LEFT JOIN tra_product p on t.productid = p.productid
		LEFT JOIN sys_collect c on t.productid = c.productId and c.collectType = '0'
		where t.toused = '1' and t.isAudit = '0' and t.isshelf = '0'
		<!-- 商品名称搜索 -->
		 <if test="productName != null and productName!='' " >
     		 and p.productname  like CONCAT('%',#{productName},'%')
      	</if>
      	 <!-- 商品分类搜索 -->
		 <if test="cateid != null and cateid!='' " >
     		 and p.cateid =#{cateid}
      	</if>
      	
      		 <!-- 商品来源搜索 -->
		 <if test="ismyself != null and ismyself!='' " >
     		 and p.ismyself =#{ismyself}
      	</if>
      	
      		 <!-- 年代搜索 -->
		 <if test="era != null and era!='' " >
     		 and p.era =#{era}
      	</if>
		group by productId,productName,productCode 
		
		 <if test="sort!=null and sort=='0'">
		 <!-- 按照日期排序 -->
		 	order by t.auditDate desc 
		 </if>
		  <if test="sort!=null and sort=='1'">
		 	<!-- 按照搜藏排序 -->
		 	order by num desc 
		 </if>
		 
		 limit #{beginIndex},#{endIndex};
   </select>
     <select id="selectBartersBySearchCount" resultType="java.lang.Integer">
     select count(0) from (
	   select t.productid productid,p.productname productname,p.productcode productcode,count(c.collectId) num from tra_trading t 
		LEFT JOIN tra_product p on t.productid = p.productid
		LEFT JOIN sys_collect c on t.productid = c.productId and c.collectType = '0'
		where t.toused = '1' and t.isAudit = '0' and t.isshelf = '0'
			<!-- 商品名称搜索 -->
		 <if test="productName != null and productName!='' " >
     		 and p.productname  like CONCAT('%',#{productName},'%')
      	</if>
      	 <!-- 商品分类搜索 -->
		 <if test="cateid != null and cateid!='' " >
     		 and p.cateid =#{cateid}
      	</if>
      	
      		 <!-- 商品来源搜索 -->
		 <if test="ismyself != null and ismyself!='' " >
     		 and p.ismyself =#{ismyself}
      	</if>
      	
      		 <!-- 年代搜索 -->
		 <if test="era != null and era!='' " >
     		 and p.era =#{era}
      	</if>
		group by productId,productName,productCode  order by t.auditDate desc  ) tt
   </select>
   
     <resultMap id="SpecialResultMap" type="com.cpf.beans.transaction.SpecialBean">
    <result column="productid" jdbcType="VARCHAR" property="productid" />
    <result column="productname" jdbcType="VARCHAR" property="productname" />
    <result column="Startingprice" jdbcType="VARCHAR" property="Startingprice" />
    <result column="zcType" jdbcType="VARCHAR" property="zcType" />
    <result column="zcid" jdbcType="VARCHAR" property="zcid" />
    <result column="num" jdbcType="VARCHAR" property="num" />
    <result column="pricetime" jdbcType="VARCHAR" property="pricetime" />
    <result column="begintime" jdbcType="VARCHAR" property="begintime" />
    <result column="endtime" jdbcType="VARCHAR" property="endtime" />
   
  </resultMap>
   
   <select id="selectSpecialBySearch"  resultMap="SpecialResultMap">
	   select tt.*,
			 if(tt.zcType='1',
			(select o.Auctionbegintime from tra_officialspecial o where o.Officialid = tt.zcid ) ,
			(select p.Auctionbegintime from tra_personalspecial p where tt.zcid = p.Specialid)
			) as begintime,
			 if(tt.zcType='1',
			(select o.Auctionendtime from tra_officialspecial o where o.Officialid = tt.zcid ) ,
			(select p.Auctionendtime from tra_personalspecial p where tt.zcid = p.Specialid)
			) as endtime
			 from (SELECT
				t.productid productid,
				p.productname productname,
				t.Startingprice Startingprice,
				t.zcType zcType,
				t.zcid zcid,
				COUNT(c.collectId) num,
				COUNT(b.recordid) pricetime
			FROM
				tra_trading t
			LEFT JOIN tra_product p ON t.productid = p.productid
			LEFT JOIN sys_collect c on t.productid = c.productId
			LEFT JOIN tra_Bidrecord b on t.productid = b.productid
			WHERE
				t.isshelf = '0'
			AND t.isAudit = '0'
			AND t.toused = '0'
			<if test="productName != null and productName!='' " >
			AND p.productname like CONCAT('%',#{productName},'%')
			</if>
			
			 <!-- 商品分类搜索 -->
		 <if test="cateid != null and cateid!='' " >
     		 and p.cateid =#{cateid}
      	</if>
      	
      		 <!-- 商品来源搜索 -->
		 <if test="ismyself != null and ismyself!='' " >
     		 and p.ismyself =#{ismyself}
      	</if>
      	
      		 <!-- 年代搜索 -->
		 <if test="era != null and era!='' " >
     		 and p.era =#{era}
      	</if>
		
			group by productid,productname,Startingprice,zcType,zcid
			
	<if test="sort!=null and sort=='0'">
		 <!-- 按照日期排序 -->
		 	order by t.auditDate desc 
		 </if>
		  <if test="sort!=null and sort=='1'">
		 	<!-- 按照搜藏排序 -->
		 	order by num desc 
		 </if>
		  ) tt  limit #{beginIndex},#{endIndex};
   
   </select>
   
      <select id="selectSpecialBySearchCount"  resultType="java.lang.Integer">
	   select count(0)
			 from (SELECT
				t.productid productid,
				p.productname productname,
				t.Startingprice Startingprice,
				t.zcType zcType,
				t.zcid zcid,
				COUNT(c.collectId) num,
				COUNT(b.recordid) pricetime
			FROM
				tra_trading t
			LEFT JOIN tra_product p ON t.productid = p.productid
			LEFT JOIN sys_collect c on t.productid = c.productId
			LEFT JOIN tra_Bidrecord b on t.productid = b.productid
			WHERE
				t.isshelf = '0'
			AND t.isAudit = '0'
			AND t.toused = '0'
			<if test="productName != null and productName!='' " >
			AND p.productname like CONCAT('%',#{productName},'%')
			</if>
			
			 <!-- 商品分类搜索 -->
		 <if test="cateid != null and cateid!='' " >
     		 and p.cateid =#{cateid}
      	</if>
      	
      		 <!-- 商品来源搜索 -->
		 <if test="ismyself != null and ismyself!='' " >
     		 and p.ismyself =#{ismyself}
      	</if>
      	
      		 <!-- 年代搜索 -->
		 <if test="era != null and era!='' " >
     		 and p.era =#{era}
      	</if>
			group by productid,productname,Startingprice,zcType,zcid
 
		 	order by t.auditDate desc 
		  
		  
		  )tt   
   
   </select>
</mapper>